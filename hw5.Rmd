---
title: "Homework 5"
author: "Sarah Vititoe"
date: "11/8/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

*This zip file contains data from a longitudinal study that included a control arm and an experimental arm. Data for each participant is included in a separate file, and file names include the subject ID and arm.*

*Create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time:*

*Start with a dataframe containing all file names; the list.files function will help*

```{r}
patient_files <- str_c("./data/", list.files(path = "./data", pattern = "^[ce][ox][np]_[0-9][0-9].csv$"))
```

```{r}
read_records <- function(files){
  
  df <- read_csv(files)
  
  df
  
}
```

*Iterate over file names and read in data for each subject using purrr::map and saving the result as a new variable in the dataframe.*

*Tidy the result; manipulate file names to include control arm and subject ID, make sure weekly observations are “tidy”, and do any other tidying that’s necessary.*

```{r}
patient_records <- patient_files %>% 
  tibble(record = .) %>% 
  group_by(record) %>% 
  nest %>% 
  mutate(data = map(.$record, read_records)) %>% 
  unnest() %>% 
  mutate(patient = str_extract(record, "[ce][ox][np]_[0-9][0-9]")) %>% 
  separate(col = patient, into = c("arm", "patient_id")) %>% 
  gather(key = "week", value = "measurement", starts_with("week")) %>% 
  mutate(arm = as.factor(recode(arm, con = "control", exp = "experimental")), 
          week = as.factor(str_replace(week, "week_", ""))) %>% 
  select(patient_id, arm, week, measurement)
```

*Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.*
```{r}
patient_records %>% 
  mutate(unique_id = str_c(patient_id, arm)) %>% 
  ggplot(aes(x = week, y = measurement, group = unique_id, color = arm)) + 
  geom_line() + 
  viridis::scale_color_viridis(
      option = "inferno", 
      begin = .2, 
      end = .8,
      name = "Arm", 
      discrete = TRUE) +
  labs(
      title = "Change in Patient Measurements Over Time", 
      y = "Measurement in Units",
      x = "Week of Observation"
    ) +
    theme_bw() + 
    theme(legend.position = "bottom") 
```

We can see that patients in the control arm seem to not change noticably in their measurement over time. Meanwhile, we see a slight in crease in the measurements of patients in our experiemental group over time. 
